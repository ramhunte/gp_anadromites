---
title: "benefit_data"
author: "Ray Hunter"
date: "2023-10-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("../common.R")
```
## do not clear environment


##IDK what this is??
```{r}
# harp_mod <- stilly_bens %>% 
#   filter(pop == "fall_chinook")
# 
# ben_by_scen <- harp_mod %>% 
#   group_by(scenario) %>% 
#     summarise(total_benefit = sum(n)) %>% 
#   arrange(desc(total_benefit))
# 
# 
# ben_by_scen %>% gt()
```

## first separate benefits into dataframes by type
```{r}
flood_bens<-stilly_bens %>% filter(scenario=="Floodplain" & pop=="fall_chinook")
elj_bens<-stilly_bens %>% filter(scenario=="Wood" & pop=="fall_chinook")  
rp_bens<-stilly_bens %>% filter(scenario=="Shade" & pop=="fall_chinook")
```

## join the benefit dataframes with the cost dataframes
```{r}
##need to load each cost rmd before these will work bc of the environment clearing
#floodplain
flood_cost_ben <- full_join(stilly_subbasin_cost, flood_bens, by = c("noaa_subba" = "subbasin"))
#ELJ
##need to change this out for the inflation adjusted cost **********
elj_cost_ben <- full_join(elj_cost_sf, elj_bens, by = c("noaa_subba" = "subbasin"))

#RP
```

## calculate cost benefit ratio
Calculate this by dividing the average cost by number of fish increase
Should we also do by perc_change?
```{r}
#floodplain
##need to manipulate values so that when n=0 (zero fish are benefitted) the ratio is 0, also I need the value to be NA when avg_cost is NA
##logically the value should never be NA (that means we didn't calculate a price for a basin with benefits)
flood_cost_ben <- flood_cost_ben %>%
  mutate(ratio_n = ifelse(!is.na(avg_cost), avg_cost / pmax(1, n-n_curr), NA))

# flood_cost_ben <- flood_cost_ben %>%
#   mutate(ratio_n = NA) %>% 
#   mutate(ratio_n = ifelse(!is.na(avg_cost), avg_cost / n-n_curr, NA))
flood_cost_ben$ratio_n <- replace(flood_cost_ben$ratio_n, is.infinite(flood_cost_ben$ratio_n), 0)
flood_cost_ben <- flood_cost_ben %>%
  mutate(ratio_n_log = if_else(!is.na(ratio_n) & ratio_n != 0, log(ratio_n), NA_real_))

#ELJ
elj_cost_ben$n_diff<-elj_cost_ben$n=elj_cost_ben$n_curr
elj_cost_ben$ratio_n<-elj_cost_ben$avg_cost/(elj_cost_ben$n_diff)
elj_cost_ben <- elj_cost_ben %>%
  mutate(ratio_n_log = if_else(!is.na(ratio_n) & ratio_n != 0, log(ratio_n), NA_real_))

#RP
```

################# Floodplain graphs ############################################
## floodplain map (shows cost per salmon for all subbasins)
```{r}
#regular scale
 ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = flood_cost_ben, aes(fill = ratio_n)) +
  # scale_fill_viridis_b(breaks = c(0, 45000000, 90000000),
  #                      labels = c("0 Million", "45 Million", "90 Million")) +
  geom_sf(data = flow_stl, color = "blue", alpha = .3) +
  # scale_fill_continuous() +
  theme_minimal()+
  labs(fill="Cost Benefit Ratio")

#log scale
 ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = flood_cost_ben, aes(fill = ratio_n_log)) +
  # scale_fill_viridis_b(breaks = c(0, 45000000, 90000000),
  #                      labels = c("0 Million", "45 Million", "90 Million")) +
  geom_sf(data = flow_stl, color = "blue", alpha = .3) +
  # scale_fill_continuous() +
  theme_minimal()+
  labs(fill="Cost Benefit Ratio")
```
## Floodplain figure
```{r}
ggplot(flood_cost_ben, aes(x = reorder(subbasin_name, -avg_cost),
                            # x = subbasin_name, #for regular ordering
                           y = avg_cost/1000000)) +
  geom_bar(stat = "summary", fun = "mean", fill = "black") +
  labs(title = "Average Cost by Subbasin",
       x = "Subbasin Name",
       y = "Average Cost (Millions of Dollars)") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Floodplain figure highlighting top 5 subbasin
```{r}
flood_cost_ben_top5<- flood_cost_ben %>% 
  arrange(desc(ratio_n)) %>% 
  slice_head(n = 5)
ggplot() +
  geom_sf(data = subs_stl, aes()) + #all subbasins
  geom_sf(data = flood_cost_ben_top5, aes(), fill="red") #select subbasin
```


################# ELJ graphs ############################################

## ELJ map
```{r}
#regular scale
ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = elj_cost_ben, aes(color = ratio_n)) + #use color, not fill bc line
  scale_color_viridis_c(option = "E", name = "Cost per Fish Increase", direction=-1)+
  theme_minimal()

#log scale
ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = elj_cost_ben, aes(color = ratio_n_log)) + #use color, not fill bc line
  scale_color_viridis_c(option = "E", name = "Log Cost per Fish Increase", direction=-1)+
  theme_minimal()
```
## ELJ figure highlighting top 5 stream segments (only in 2 subbasins)
```{r}
# join to another df with geometry is associated with floodplain, but the river
elj_cost_ben_no_geo<-st_drop_geometry(elj_cost_ben)
stl_subs_geo<-subs_stl %>% select(noaa_subba)
elj_cost_ben_sub<-left_join(elj_cost_ben_no_geo, stl_subs_geo)
#then take top 5 subbasins
elj_cost_ben_top5<- elj_cost_ben_sub %>% 
  arrange(desc(ratio_n)) %>% 
  slice_head(n = 5)
elj_cost_ben_top5<-st_as_sf(elj_cost_ben_top5)
ggplot() +
  geom_sf(data = subs_stl, aes()) + #all subbasins
  geom_sf(data = elj_cost_ben_top5, aes(), fill="red") #select subbasin
```



################# Riparian Planting graphs ############################################
## RP map
```{r}

```

