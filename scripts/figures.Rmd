---
title: "final_figures"
author: "Ray Hunter"
date: "2024-01-17"
output: 
  html_document:
    code_folding: "hide"
---
## Preliminary Results {.tabset}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(sf)
library(terra)
library(ggspatial)
# library(tmap)
library(here)
library(janitor)
library(ggplot2)
library(kableExtra)
library(magrittr)
library(knitr)
library(basemaps)

#sourcing data
source("../common.R")
source("functions.R")
```

```{r}
#reading in data 

#floodplain habitat
floodplain<-read_sf(here("data", "final_dfs", "fp_costs.gpkg")) %>% 
  select(-c("scenario", "subbasin_num"))
floodplain$restoration_type<-"floodplain"

#engineered log jams 
elj<-read_sf(here("data", "final_dfs", "elj_costs.gpkg"))
elj$restoration_type<-"elj"

#riparian planting 
rp<-read_sf(here("data", "final_dfs", "rp_costs.gpkg")) %>% 
  select(-scenario)
rp$restoration_type<-"rp"


#creating one large dataframe
all_cost_benefit <- rbind(elj, rp)
all_cost_benefit<-rbind(all_cost_benefit, floodplain)



#creating a column with pretty subbasin names
all_cost_benefit$subbasin_name <- str_replace_all(all_cost_benefit$noaa_subba, "_", " ") 
all_cost_benefit$subbasin_name <-str_replace_all(all_cost_benefit$subbasin_name, "Stillaguamish", "")
all_cost_benefit$subbasin_name <-str_replace_all(all_cost_benefit$subbasin_name, "mainstem", "Mainstem")



#needed for loops for maps later on
unique_types <- unique(all_cost_benefit$restoration_type)


# test <- all_cost_benefit %>%
#   filter(pop == "fall_chinook")
```


```{r, fig.cap="Top 5 Subbasins for Riparian Planting"}

# Create an empty list to store datasets
top_subbasins_list <- list()

# Loop through each restoration_type
for (rest_type in unique_types) {
  # cat("Top five subbasins for Restoration Type:", rest_type, "\n")
  
  # Subset the data for the current restoration_type
  subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == rest_type, ]
  
  # Get the top five subbasins
  top_subbasins <- subset_data %>%
    arrange(desc(cb_ratio)) %>%
    head(5) %>% 
    select(subbasin_name, total_lower_cost, total_avg_cost, total_upper_cost, n_diff, cb_ratio) %>% st_drop_geometry()
  
  # Store the dataset in the list
  top_subbasins_list[[rest_type]] <- top_subbasins
  
  cat("\n")
}

# # Apply kable to each dataset in the list
# kable_output <- lapply(top_subbasins_list, function(dataset) {
#   kable(dataset, format = "markdown")
# })

# # Print the kable output
# print(kable_output)
kable(top_subbasins_list[["rp"]], "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

```{r, fig.cap="Top 5 Subbasins for Engineered Log Jams"}
kable(top_subbasins_list[["elj"]], "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, fig.cap="Top 5 Subbasins for Floodplain Restoration"}
kable(top_subbasins_list[["floodplain"]], "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```


```{r}
###PLOT SHOWING THE AVERAGE COST OF RESTORATION IN EACH SUBBASIN

# Filter out rows with NA values for total_avg_cost
all_cost_benefit_NA <- all_cost_benefit[!is.na(all_cost_benefit$total_avg_cost), ]

# Create ggplot
p<-ggplot(filter(all_cost_benefit_NA, restoration_type == "rp"), aes(x = subbasin_name, y = total_avg_cost/1000000)) +
  geom_bar(stat = "identity", position = "dodge", color = "black", width = 0.7) +
  geom_errorbar(
    aes(ymin = total_lower_cost/1000000, ymax = total_upper_cost/1000000),
    position = position_dodge(0.7),
    width = 0.25
  ) +
  labs(x = "Subbasin",
       y = "Cost (Millions of Dollars)",
       fill = "Restoration Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
p
```


```{r}
# make_cb_plot<-function(rest_type){
# 
# # Subset the data for the current restoration_type
#   subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == rest_type, ]
#   # filter to remove subbasins with 0 cb ratio
#   subset_data <- subset_data %>% filter(cb_ratio>0)%>% filter(pop=="fall_chinook")
# 
#   
#   # Create ggplot for the current restoration_type
#   plot <- ggplot() +
#     geom_sf(data = subs_stl, aes()) +
#     geom_sf(data = subset_data, aes(fill = cb_ratio)) +
#     scale_fill_gradient(low = "#CE8CE1", high = "#602173") +  # Adjust colors as needed
#     geom_sf(data = flow_stl, color = "#1619CD", alpha = .3) +
#     theme_minimal() +
#     labs(fill = "Price per\nSpawners (Dollars)")
#   
#   return(plot)
# }
# 
# make_cb_plot(elj)


subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == "rp", ]
# filter to remove subbasins with 0 cb ratio
subset_data <- subset_data %>% filter(cb_ratio>0) %>% filter(pop=="fall_chinook")
center <- c(lon = -121, lat = 48.25)
# Create a ggmap object with the topographic tiles
# topographic_map <- ggmap::get_map(location=c(lon = -121, lat = 48.25), zoom=11, maptype = 'terrain-background', source = 'stadia')
  
# Create ggplot for the current restoration_type
plot <- ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = subset_data, aes(fill = cb_ratio/100000)) +
  scale_fill_gradient(low = "#DDBEE7", high = "#602173") +  # Adjust colors as needed
  geom_sf(data = flow_stl, color = "#1619CD", alpha = .3) +
  theme_minimal() +
  labs(fill = "Cost Effectiveness\nScore (Hundred Thousand\nDollars per Spawner)")
plot+ggspatial::annotation_scale(height = unit(0.15, "cm"))+
  ggspatial::annotation_north_arrow(height = unit(1.0, "cm"),width = unit(0.75, "cm"), pad_x = unit(1.0, "cm"),pad_y = unit(1, "cm"))

```



 





# cost dumb bell figures 

```{r}
# floodplain
fp_dumb_bell <- cost_graph_fun(all_cost_benefit, "floodplain", "Floodplain")

ggsave("../final_prods/figures/fp_dumb_bell.jpeg", plot = fp_dumb_bell, device = "jpeg", width = 8, height = 6, units = "in")

# elj
elj_dumb_bell <- cost_graph_fun(all_cost_benefit, "elj", "Engineered Log Jam")
ggsave("../final_prods/figures/elj_dumb_bell.jpeg", plot = elj_dumb_bell, device = "jpeg", width = 8, height = 6, units = "in")

# rp
rp_dumb_bell <- cost_graph_fun(all_cost_benefit, "rp", "Riparian Planting")

ggsave("../final_prods/figures/rp_dumb_bell.jpeg", plot = rp_dumb_bell, device = "jpeg", width = 8, height = 6, units = "in")
```


# table 
```{r}


final_df <- all_cost_benefit %>%


  filter(pop == "fall_chinook") %>% 
  arrange(subbasin_name) 

summary_df <- final_df %>% 
  transmute("Subbasin Name" = subbasin_name,
            "Restoration Type" = restoration_type,
            "Lower Cost" = paste("$", format(round(total_lower_cost), big.mark = ",")),
            # "Lower Cost" = paste("$", format(round(total_lower_cost), big.mark = ",")),
            "Upper Cost" = paste("$", format(round(total_upper_cost), big.mark = ",")),
            "Average Cost" = paste("$", format(round(total_avg_cost), big.mark = ",")),
            "Spawners" = round(n_diff, digits = 2),
            "CB Ratio" = paste("$", format(round(cb_ratio, digits = 2), big.mark = ","))) %>% 
  st_drop_geometry() %>% 
  as.data.frame()
  
 summary_kable <- kable(summary_df)  %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) 
 summary_kable

  
# htmlTable::htmlTable(summary_kable, rnames=FALSE) %>%  
#    save_kable(file = "../final_prods/tables/summary_kable.png")

summary_kable %>% 
  save_kable(file = "../final_prods/tables/summary_kable.png", zoom = 4)

floodplain_table<-summary_table_builder("floodplain")
elj_table<-summary_table_builder("elj") 
rp_table<-summary_table_builder("rp")

# save_kable(here("final_prods","tables","floodplain_kable.png"))
floodplain_table %>% 
  save_kable(here("final_prods","tables","floodplain_kable.html"))
elj_table %>% 
  save_kable(here("final_prods","tables","elj_kable.html"))
rp_table %>% 
  save_kable(here("final_prods","tables","rp_kable.html"))

# webshot::webshot(here("final_prods","tables","floodplain_kable.html"), file=here("final_prods","tables","floodplain_kable.html"))
save_kable(elj_table, here("final_prods","tables","elj_kable.png"), zoom = 4)
save_kable(rp_table, here("final_prods","tables","rp_kable.png"), zoom = 4)


```

```{r}
#top five basins for each
floodplain_top<-all_cost_benefit %>% filter(pop=="fall_chinook") %>% 
  filter(restoration_type=="floodplain") %>% arrange(desc(cb_ratio))
elj_top<-all_cost_benefit %>% filter(pop=="fall_chinook") %>% 
  filter(restoration_type=="elj") %>% arrange(desc(cb_ratio))
rp_top<-all_cost_benefit %>% filter(pop=="fall_chinook") %>% 
  filter(restoration_type=="rp") %>% arrange(desc(cb_ratio))
```

### Showing benefits by restoration type 
```{r}
custom_colors <- c("elj" = "sienna1", 
                   "floodplain" = "palegreen3",
                   "rp" = "mediumpurple1")

ggplot(all_cost_benefit, aes(x = subbasin_name, y = n_diff, fill = restoration_type)) +
  geom_bar(stat = "identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(fill = "Restoration Type", x="Subbasin Name", y="Increase in Chinook Spawners")+
  scale_fill_manual(values = custom_colors)
```

```{r}
fp_area_subbasin<-read_csv(here("data", "final_dfs", "fp_area_subbasin.csv"))
#creating a column with pretty subbasin names
fp_area_subbasin$subbasin_name <- str_replace_all(fp_area_subbasin$noaa_subba, "_", " ") 
fp_area_subbasin$subbasin_name <-str_replace_all(fp_area_subbasin$subbasin_name, "Stillaguamish", "")
fp_area_subbasin$subbasin_name <-str_replace_all(fp_area_subbasin$subbasin_name, "mainstem", "Mainstem")
fp_area_subbasin$hab_unit<-str_replace_all(fp_area_subbasin$hab_unit, "side_channel", "Side Channel")

custom_colors <- c("Marsh" = "sienna1", 
                   "Pond" = "palegreen3",
                   "Side Channel" = "mediumpurple1")

ggplot(fp_area_subbasin, aes(x = subbasin_name, y = total_area_ha, fill = hab_unit)) +
  geom_bar(stat = "identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(fill = "Habitat Type", x="Subbasin Name", y="Increase in Chinook Spawners")+
  scale_fill_manual(values = custom_colors)

marsh_area<-fp_area_subbasin %>% filter(hab_unit=="Marsh") %>% arrange(desc(total_area_ha))%>%
  mutate(subbasin_name = factor(subbasin_name, levels = subbasin_name))

marsh_area<-ggplot(marsh_area, aes(x=subbasin_name, y = total_area_ha))+
  geom_bar(stat = "identity", fill="royalblue4")+  theme_minimal()+
  labs(x="Subbasin Name", y="Area (ha)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave(here("final_prods", "figures", "marsh_area_subbasin.jpg"), marsh_area)


sc_area<-fp_area_subbasin %>% filter(hab_unit=="Side Channel") %>% arrange(desc(total_area_ha))%>%
  mutate(subbasin_name = factor(subbasin_name, levels = subbasin_name))

sc_area<-ggplot(sc_area, aes(x=subbasin_name, y = total_area_ha))+
  geom_bar(stat = "identity", fill="royalblue4")+  theme_minimal()+
  labs(x="Subbasin Name", y="Area (ha)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave(here("final_prods", "figures", "sidechannel_area_subbasin.jpg"), sc_area)
```


# cost effectiveness vs spawners
```{r}
all_cost_benefit %>% 
  filter(pop == "fall_chinook") %>% 
  ggplot(aes(x = n_diff, y = cb_ratio, color = restoration_type)) +
  geom_point() +
  ylim(ymin = 0, ymax = 500000)
       )
```

```{r}
final_df %>% 
  arrange(cb_ratio) %>% 
  head(20) %>% 
  select(subbasin_name, restoration_type,  n_diff, cb_ratio, total_lower_cost, total_upper_cost, total_avg_cost) %>% 
  view()
           
```













