---
title: "final_figures"
author: "Ray Hunter"
date: "2024-01-17"
output: 
  html_document:
    code_folding: "hide"
---
## Preliminary Results {.tabset}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(sf)
library(terra)
library(ggspatial)
# library(tmap)
library(here)
library(janitor)
library(ggplot2)
library(kableExtra)
library(knitr)
library(basemaps)

#sourcing data
source("../common.R")
```

```{r}
#reading in data 

#floodplain habitat
floodplain<-read_sf(here("data", "final_dfs", "fp_costs.gpkg")) %>% 
  select(-c("scenario", "subbasin_num"))
floodplain$restoration_type<-"floodplain"

#engineered log jams 
elj<-read_sf(here("data", "final_dfs", "elj_costs.gpkg"))
elj$restoration_type<-"elj"

#riparian planting 
rp<-read_sf(here("data", "final_dfs", "rp_costs.gpkg")) %>% 
  select(-scenario)
rp$restoration_type<-"rp"


#creating one large dataframe
all_cost_benefit <- rbind(elj, rp)
all_cost_benefit<-rbind(all_cost_benefit, floodplain)



#creating a column with pretty subbasin names
all_cost_benefit$subbasin_name <- str_replace_all(all_cost_benefit$noaa_subba, "_", " ") 
all_cost_benefit$subbasin_name <-str_replace_all(all_cost_benefit$subbasin_name, "Stillaguamish", "")
all_cost_benefit$subbasin_name <-str_replace_all(all_cost_benefit$subbasin_name, "mainstem", "Mainstem")



#needed for loops for maps later on
unique_types <- unique(all_cost_benefit$restoration_type)


# test <- all_cost_benefit %>%
#   filter(pop == "fall_chinook")
```


```{r, fig.cap="Top 5 Subbasins for Riparian Planting"}

# Create an empty list to store datasets
top_subbasins_list <- list()

# Loop through each restoration_type
for (rest_type in unique_types) {
  # cat("Top five subbasins for Restoration Type:", rest_type, "\n")
  
  # Subset the data for the current restoration_type
  subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == rest_type, ]
  
  # Get the top five subbasins
  top_subbasins <- subset_data %>%
    arrange(desc(cb_ratio)) %>%
    head(5) %>% 
    select(subbasin_name, total_lower_cost, total_avg_cost, total_upper_cost, n_diff, cb_ratio) %>% st_drop_geometry()
  
  # Store the dataset in the list
  top_subbasins_list[[rest_type]] <- top_subbasins
  
  cat("\n")
}

# # Apply kable to each dataset in the list
# kable_output <- lapply(top_subbasins_list, function(dataset) {
#   kable(dataset, format = "markdown")
# })

# # Print the kable output
# print(kable_output)
kable(top_subbasins_list[["rp"]], "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

```

```{r, fig.cap="Top 5 Subbasins for Engineered Log Jams"}
kable(top_subbasins_list[["elj"]], "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

```{r, fig.cap="Top 5 Subbasins for Floodplain Restoration"}
kable(top_subbasins_list[["floodplain"]], "html") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```


```{r}
###PLOT SHOWING THE AVERAGE COST OF RESTORATION IN EACH SUBBASIN

# Filter out rows with NA values for total_avg_cost
all_cost_benefit_NA <- all_cost_benefit[!is.na(all_cost_benefit$total_avg_cost), ]

# Create ggplot
p<-ggplot(filter(all_cost_benefit_NA, restoration_type == "rp"), aes(x = subbasin_name, y = total_avg_cost/1000000)) +
  geom_bar(stat = "identity", position = "dodge", color = "black", width = 0.7) +
  geom_errorbar(
    aes(ymin = total_lower_cost/1000000, ymax = total_upper_cost/1000000),
    position = position_dodge(0.7),
    width = 0.25
  ) +
  labs(x = "Subbasin",
       y = "Cost (Millions of Dollars)",
       fill = "Restoration Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
p
```


```{r}
###MAPPING COST BENEFIT RATIO
# Create a list to store individual ggplot objects
cb_plot_list <- list()

# Loop through each restoration_type
for (rest_type in unique_types) {
  # Subset the data for the current restoration_type
  subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == rest_type, ]
  # filter to remove subbasins with 0 cb ratio
  subset_data <- subset_data %>% filter(cb_ratio>0)
  
  # Create ggplot for the current restoration_type
  plot <- ggplot() +
    geom_sf(data = subs_stl, aes()) +
    geom_sf(data = subset_data, aes(fill = cb_ratio)) +
    scale_fill_gradient(low = "#D2A076", high = "#663C18") +  # Adjust colors as needed
    geom_sf(data = flow_stl, color = "#1619CD", alpha = .3) +
    theme_minimal() +
    labs(fill = "Price per\nSpawners (Dollars)") 
  
  # Append the plot to the list
  cb_plot_list[[rest_type]] <- plot
}

# # Save the individual plots
# for (rest_type in unique_types) {
#   ggsave(paste0("plot_", rest_type, ".png"), cost_plot_list[[rest_type]])}

# Assuming you have already generated and stored the plots in the list 'plot_list'

# Display the plot for a specific restoration_type (replace 'RestorationTypeA' with the actual type)
# print(benefit_plot_list[["rp"]])
# print(benefit_plot_list[["floodplain"]])
# print(benefit_plot_list[["elj"]])
```
 
```{r}
make_cb_plot<-function(rest_type){

# Subset the data for the current restoration_type
  subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == rest_type, ]
  # filter to remove subbasins with 0 cb ratio
  subset_data <- subset_data %>% filter(cb_ratio>0)%>% filter(pop=="fall_chinook")

  
  # Create ggplot for the current restoration_type
  plot <- ggplot() +
    geom_sf(data = subs_stl, aes()) +
    geom_sf(data = subset_data, aes(fill = cb_ratio)) +
    scale_fill_gradient(low = "#CE8CE1", high = "#602173") +  # Adjust colors as needed
    geom_sf(data = flow_stl, color = "#1619CD", alpha = .3) +
    theme_minimal() +
    labs(fill = "Price per\nSpawners (Dollars)")
  
  return(plot)
}

make_cb_plot(elj)


subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == "elj", ]
# filter to remove subbasins with 0 cb ratio
subset_data <- subset_data %>% filter(cb_ratio>0) 
center <- c(lon = -121, lat = 48.25)
# Create a ggmap object with the topographic tiles
topographic_map <- ggmap::get_map(location=c(lon = -121, lat = 48.25), zoom=11, maptype = 'terrain-background', source = 'stadia')
  
# Create ggplot for the current restoration_type
plot <- ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = subset_data, aes(fill = cb_ratio)) +
  scale_fill_gradient(low = "#DDBEE7", high = "#602173") +  # Adjust colors as needed
  geom_sf(data = flow_stl, color = "#1619CD", alpha = .3) +
  theme_minimal() +
  labs(fill = "Price per\nSpawners (Dollars)")
plot+ggspatial::annotation_scale(height = unit(0.15, "cm"))+
  ggspatial::annotation_north_arrow(height = unit(1.0, "cm"),width = unit(0.75, "cm"), pad_x = unit(1.0, "cm"),pad_y = unit(1, "cm"))

```

 
```{r}
### PLOTTING COSTS BY SUBBASIN
# Create a list to store individual ggplot objects
cost_range_plot_list <- list()

# Loop through each restoration_type
for (rest_type in unique_types) {
  # Subset the data for the current restoration_type
  subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == rest_type, ]
  
  subset_data <- subset_data %>% 
    filter(pop == "fall_chinook")
  
  # Filter out rows with NA values for total_avg_cost
  subset_data <- subset_data[!is.na(subset_data$total_avg_cost), ]
  
  
  # Order subbasin_name by total_avg_cost in descending order
  subset_data$subbasin_name <- factor(subset_data$subbasin_name, levels = subset_data$subbasin_name[order(-subset_data$total_avg_cost)])
  
  # Create ggplot for the current restoration_type
  plot <- ggplot(subset_data, aes(x = subbasin_name)) +
    geom_errorbar(
      aes(ymin = total_lower_cost/1000000, ymax = total_upper_cost/1000000),
      position = "dodge",
      width = 0.2
    ) +
    geom_point(aes(y = total_avg_cost/1000000), position = "dodge", size = 3) +
    labs(x = "Subbasin",
         y = "Cost (Millions of Dollars)") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  
  # Append the plot to the list
  cost_range_plot_list[[rest_type]] <- plot
}


```

 
### Riparian Planting

```{r, fig.cap="Cost Benefit Ratio from Riparian Planting in the Stillaguamish"}
print(cb_plot_list[["rp"]])
```

```{r, fig.cap="Cost Ranges by Subbasin to Implement Riparian Planting in the Stillaguamish"}
print(cost_range_plot_list[["rp"]])
```

### Engineered Log Jams

```{r, fig.cap="Cost Benefit Ratio from Engineered Log Jams in the Stillaguamish"}
print(cb_plot_list[["elj"]])
```

```{r, fig.cap="Cost Ranges by Subbasin to Implement Engineered Log Jams in the Stillaguamish"}
print(cost_range_plot_list[["elj"]])
```

### Floodplain Restoration

```{r, fig.cap="Cost Benefit Ratio from Floodplain Restoration in the Stillaguamish"}
print(cb_plot_list[["floodplain"]])
```

```{r, fig.cap="Cost Ranges by Subbasin to Implement Floodplain Restoration in the Stillaguamish"}
print(cost_range_plot_list[["floodplain"]])
```


























