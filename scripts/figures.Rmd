---
title: "final_figures"
author: "Ray Hunter"
date: "2024-01-17"
output: 
  html_document:
    code_folding: "hide"
---
## Preliminary Results {.tabset}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(sf)
library(terra)
library(ggspatial)
# library(tmap)
library(here)
library(janitor)
library(ggplot2)
library(kableExtra)
library(magrittr)
library(knitr)
library(basemaps)

#sourcing data
source("../common.R")
source("functions.R")

# color themes 
custom_colors <- c("rp" = "#03045E",
                     # "#1F271B",
                   "elj" = "#19647E", 
                   "floodplain" = "#28AFB0")
```


# Data wrangling 

```{r}
#reading in data 

#floodplain habitat
floodplain<-read_sf(here("data", "final_dfs", "fp_costs.gpkg")) %>% 
  select(-c("scenario", "subbasin_num")) %>% 
  mutate(restoration_type = "floodplain")

#engineered log jams 
elj<-read_sf(here("data", "final_dfs", "elj_costs.gpkg")) %>% 
  mutate(restoration_type = "elj")

#riparian planting 
rp<-read_sf(here("data", "final_dfs", "rp_costs.gpkg")) %>% 
  select(-scenario) %>% 
  mutate(restoration_type = "rp")


#creating a master df
all_cost_benefit <- rbind(floodplain, elj)
all_cost_benefit <- rbind(all_cost_benefit, rp) %>% 
  #cleaning names
  mutate(subbasin_name = str_replace_all(noaa_subba, "_", " "),
         subbasin_name = str_replace_all(subbasin_name, "Stillaguamish", ""),
         subbasin_name = str_replace_all(subbasin_name, "mainstem", "Mainstem")
) 

```



# MAPS

```{r}
subset_data <- all_cost_benefit[all_cost_benefit$restoration_type == "rp", ]
# filter to remove subbasins with 0 cb ratio
subset_data <- subset_data %>% filter(cb_ratio>0) %>% filter(pop=="fall_chinook")
center <- c(lon = -121, lat = 48.25)
# Create a ggmap object with the topographic tiles
# topographic_map <- ggmap::get_map(location=c(lon = -121, lat = 48.25), zoom=11, maptype = 'terrain-background', source = 'stadia')
  
# Create ggplot for the current restoration_type
plot <- ggplot() +
  geom_sf(data = subs_stl, aes()) +
  geom_sf(data = subset_data, aes(fill = cb_ratio/100000)) +
  scale_fill_gradient(low = "#DDBEE7", high = "#602173") +  # Adjust colors as needed
  geom_sf(data = flow_stl, color = "#1619CD", alpha = .3) +
  theme_minimal() +
  labs(fill = "Cost Effectiveness\nScore (Hundred Thousand\nDollars per Spawner)")
plot+ggspatial::annotation_scale(height = unit(0.15, "cm"))+
  ggspatial::annotation_north_arrow(height = unit(1.0, "cm"),width = unit(0.75, "cm"), pad_x = unit(1.0, "cm"),pad_y = unit(1, "cm"))

```



 
# DUMB BELL CHARTS

```{r}
# floodplain
fp_dumb_bell <- cost_graph_fun(all_cost_benefit, "floodplain", "Floodplain")

ggsave("../final_prods/figures/fp_dumb_bell.jpeg", plot = fp_dumb_bell, device = "jpeg", width = 8, height = 6, units = "in")

# elj
elj_dumb_bell <- cost_graph_fun(all_cost_benefit, "elj", "Engineered Log Jam")
ggsave("../final_prods/figures/elj_dumb_bell.jpeg", plot = elj_dumb_bell, device = "jpeg", width = 8, height = 6, units = "in")

# rp
rp_dumb_bell <- cost_graph_fun(all_cost_benefit, "rp", "Riparian Planting")

ggsave("../final_prods/figures/rp_dumb_bell.jpeg", plot = rp_dumb_bell, device = "jpeg", width = 8, height = 6, units = "in")
```


# TABLES 

```{r}
#---------------- creating tables 

# fp table
floodplain_table <- summary_table_builder("floodplain")

#elj table 
elj_table <- summary_table_builder("elj") %>% 
   save_kable(file = here("final_prods","tables","elj_kable.html"), zoom = 4)

# rp table
rp_table <- summary_table_builder("rp") %>% 
   save_kable(file = here("final_prods","tables","rp_kable.html"), zoom = 4)


#------------------- saving tables 

floodplain_table %>% 
  save_kable(file = here("final_prods","tables","floodplain_kable.html"), zoom = 4)

elj_table %>% 
   save_kable(file = here("final_prods","tables","elj_kable.html"), zoom = 4)

rp_table %>% 
   save_kable(file = here("final_prods","tables","rp_kable.html"), zoom = 4)

```


### Spawner Bar Chart
```{r}

#creating a bar chart with spawners by action and subbasin

spawner_barchart <- all_cost_benefit %>% 
  filter(pop == "fall_chinook") %>% 
  mutate(subbasin_name = fct_reorder(subbasin_name, n_diff, .fun = sum),
         restoration_type = factor(restoration_type,
                                   levels = c( "rp", "elj", "floodplain"))) %>% 
  group_by(subbasin_name) %>% 
  # creating a column to identify where the labels of the n_diff will go on the bar chart for each restoration type in each subbasin
  mutate(label_y = cumsum(n_diff) - .5 * n_diff) %>% 

ggplot(aes(x = subbasin_name, 
           y = n_diff, fill = restoration_type)) +
  theme_minimal() +
  geom_col() +
  labs(fill = "Restoration Type", 
       x = "", 
       y = "# Chinook Spawners",
       title = "Modeled Annual Chinook Spawner Increases",
       subtitle = "by subbasin and restoration action",
       caption = "Data Source: Beechie, T. J., Goodman, A., Stefankiv, O., Timpane-Padgham, B., & Lowe, M. (2023). \n Habitat Assessment and Restoration Planning (HARP) Model for the Snohomish and Stillaguamish \n River Basins (noaa:48860).") +
  coord_flip() +
  scale_fill_manual(values = custom_colors,
                    labels = c("Riparian Planting",
                               "Engineered Log Jam",
                               "Floodplain"),
                    guide = guide_legend(reverse = TRUE)) +
  geom_text(aes(y = label_y, label = round(n_diff)), color = "white", alpha = 0.5) +
  
  # pushing y axis labels to edhe of data 
  scale_y_continuous(expand = c(0,0)) +
  
 # scale_y_continuous(limits = c(0, 85)) +
  theme(
    #axes
    axis.text = element_text(size = 10),
    axis.title.x = element_text(margin = margin(t = 12, r = 0, b = 30, l = 20), size = 12),
    #legend
    legend.position = c(0.5, -0.175),
    legend.direction = "horizontal",
    legend.title = element_blank(),
      # legend.box.background = element_rect(color = "grey"))
    # titles
    plot.title = element_text(hjust = 0, vjust = 1.8, size = 16),
    plot.subtitle = element_text(hjust = 0, vjust = 2.2),
    plot.caption = element_text(face = "italic", size = 6),
    # gridlines
    panel.grid.major.y  = element_blank(),
    panel.grid.minor.x  = element_blank()
    ) 

spawner_barchart

ggsave("../final_prods/figures/spawner_barchart.jpeg", plot = spawner_barchart, device = "jpeg", width = 8, height = 6, units = "in")

```








```{r}
fp_area_subbasin<-read_csv(here("data", "final_dfs", "fp_area_subbasin.csv"))
#creating a column with pretty subbasin names
fp_area_subbasin$subbasin_name <- str_replace_all(fp_area_subbasin$noaa_subba, "_", " ") 
fp_area_subbasin$subbasin_name <-str_replace_all(fp_area_subbasin$subbasin_name, "Stillaguamish", "")
fp_area_subbasin$subbasin_name <-str_replace_all(fp_area_subbasin$subbasin_name, "mainstem", "Mainstem")
fp_area_subbasin$hab_unit<-str_replace_all(fp_area_subbasin$hab_unit, "side_channel", "Side Channel")

custom_colors <- c("Marsh" = "sienna1", 
                   "Pond" = "palegreen3",
                   "Side Channel" = "mediumpurple1")

ggplot(fp_area_subbasin, aes(x = subbasin_name, y = total_area_ha, fill = hab_unit)) +
  geom_bar(stat = "identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(fill = "Habitat Type", x="Subbasin Name", y="Increase in Chinook Spawners")+
  scale_fill_manual(values = custom_colors)

marsh_area<-fp_area_subbasin %>% filter(hab_unit=="Marsh") %>% arrange(desc(total_area_ha))%>%
  mutate(subbasin_name = factor(subbasin_name, levels = subbasin_name))

marsh_area<-ggplot(marsh_area, aes(x=subbasin_name, y = total_area_ha))+
  geom_bar(stat = "identity", fill="royalblue4")+  theme_minimal()+
  labs(x="Subbasin Name", y="Area (ha)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# ggsave(here("final_prods", "figures", "marsh_area_subbasin.jpg"), marsh_area)


sc_area<-fp_area_subbasin %>% filter(hab_unit=="Side Channel") %>% arrange(desc(total_area_ha))%>%
  mutate(subbasin_name = factor(subbasin_name, levels = subbasin_name))

sc_area<-ggplot(sc_area, aes(x=subbasin_name, y = total_area_ha))+
  geom_bar(stat = "identity", fill="royalblue4")+  theme_minimal()+
  labs(x="Subbasin Name", y="Area (ha)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ggsave(here("final_prods", "figures", "sidechannel_area_subbasin.jpg"), sc_area)
```


# cost effectiveness vs spawners
```{r}
all_cost_benefit %>% 
  filter(pop == "fall_chinook") %>% 
  ggplot(aes(x = n_diff, y = cb_ratio, color = restoration_type)) +
  geom_point() +
  ylim(ymin = 0, ymax = 500000)
       
```














