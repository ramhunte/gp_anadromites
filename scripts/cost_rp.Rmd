---
title: "cost_rp"
author: "Ray Hunter"
date: "2023-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include=FALSE, message = FALSE, error = FALSE)

#clearing environment
rm(list = ls())

#sourcing data
source("../common.R")
source("functions.R")

setwd(here())
```


### Data wrangling
```{r}
# filtering data to just subbasins where there there are chinook benefits from shade

#filter to just subbasins with benefits in shade for chinook
stilly_bens_rp <- stilly_bens %>% 
  filter(pop == "fall_chinook" &
         perc_change > 0 &
        scenario == "Shade") 

#filter flow_stl to just streams with beenfits for shade and chinook 
flow_stl_rp <- flow_stl %>% 
  filter(noaa_subba %in% unique(stilly_bens_rp$subbasin))
```


### 1) IMPACT OF SITE ACCESSIBILITY AND MATERIALS ON COSTS

## 1.1) SITE ACCESSABILITY: FIND THE NEAREST ROAD TO EACH STREAM REACH and ASSIGN LMH (STOLEN FROM ELJ)
* in common R, the transportation (site accessibility) was added to the `flow_stl` data frame


## 1.2) MATERIALS: STREAM ENERGY USED TO CALCULATE MATERIALS COSTS (STOLEN FROM ELJ)
```{r}
# using energy function from function.R to assign energy 

#assigning energy 
flow_stl_rp <- assign_energy_width(flow_stl_rp)

# check energy levels 
unique(flow_stl_rp$energy) #only low and medium energy streams 
```



## 1.3) CALCULATE RELATIVE COST BASED ON MATERIALS (ENERGY) AND SITE ACCESSABILITY (TRANSPORTATION) (STOLEN FROM ELJ)
```{r}
#energy column is called energy (low, medium and high) and transportation is distance_to_nearest_road_mi (values are low, medium and high)

calculate_intermediate_cost <- function(input_df) {
  input_df <- input_df %>%
    mutate(
      intermediate_cost = case_when(
        transportation == "low" & energy == "low" |
        transportation == "low" & energy == "medium" ~ "low",
        transportation == "low" & energy == "high" |
        transportation == "medium" & energy == "low" |
        transportation == "medium" & energy == "medium" ~ "medium",
        transportation == "medium" & energy == "high" |
        transportation == "high" & energy == "low" |
        transportation == "high" & energy == "medium" |
        transportation == "high" & energy == "high" ~ "high",
        # Add more conditions for other combinations here
        TRUE ~ "Unknown"  # Default value if no conditions match
      )
    )
  
  return(input_df)
}
  flow_stl_rp <- calculate_intermediate_cost(flow_stl_rp)

```


### 2) COST OF RIPARIAN PLANTING PROJECTS ($/acre)

matrix with levels of site preparation ( average slope ) and output from materials/accessibility 

need to measure the average slope around a stream within 50m 

#### 2.1) LEVEL OF SITE PREPARATION 

```{r}
#### creating a slope raster file of the stillaguamish, extracting average slope by surround stream reach buffer, and classifying it as low, medium, or high to estimate level of site preparation
###---------------------------------------------------------------------------------------

# importing multiple elevation raster data files (stored in "elevation" folder) from:
# Data: https://gis.ess.washington.edu/data/raster/tenmeter/byquad/info.html

# listing the dem elevation files 
elev_list <- list.files(path = "../data/elevation", "dem$", full.names = TRUE)

#  rasterizing elevation dem files and storing them in a collection 
elev_list_rast <- sprc(lapply(elev_list, rast)) 

# combining rasters into 1 mosaic
slope_rast <- mosaic(elev_list_rast) %>% 
# projecting NAD83 to mach NOAA stream data
 project("EPSG:26910") %>% 
#calculating slope from elevation data
terrain(v = "slope", unit = "degrees")

# creating a 50m buffer around stream edges
flow_buff <- st_buffer(flow_stl_rp, dist = 50, endCapStyle = "FLAT")

# cropping and masking slope raster data to stream buffer
crop_rast <- crop(slope_rast, flow_buff, mask = TRUE)

#extract mean 
extract <- extract(crop_rast, flow_buff, fun = mean)

#joining avg slope to original flow_stl 
flow_stl_rp <- flow_stl_rp %>% 
  mutate(avg_bank_slope = extract$slope)


#-------------------------------------------------------------------


#### create function to classify slope 
bank_slope_cost_fun <- function(slope) {
  bank_slope_class <- ifelse(slope >= 0 & slope <= 10, "low",
                ifelse(slope > 10 & slope <= 20, "medium", "high"))
  return(bank_slope_class)
}




#assigning a bank slope class w/ function
flow_stl_rp <- flow_stl_rp %>%
  mutate(bank_slope_class = bank_slope_cost_fun(avg_bank_slope),
        #creating acres of riparian vegetaion. may need to be changed
         #60m (30m on each side) the area of the stream reach converted to acres
         rip_acres = 60*length*0.000247105,
        #calculating % change in canopy open angle to estimate how much riparian restoration needs to be done in rip_acres
        #current angle - historical angle / current angle x 100 to get % change
        can_ang_chg_perc = ((can_ang - hist_ang)/hist_ang*100),
        can_ang_bin = case_when(
          #when greater than or equal to 1, then 100% rest needed
          can_ang_chg_perc >= 95 ~ 1,
          can_ang_chg_perc >= 66.66 ~ .75,
          can_ang_chg_perc >= 33.33 ~ .5,
          can_ang_chg_perc >= 5 ~ .25,
          can_ang_chg_perc < 5 ~ 0,
          
                                 ))

```



### 3) COST OF RIPARIAN PLANTING PROJECTS 
### MATERIALS/SITE ACCESSIBILITY X SITE PREPARATION

```{r}
rp_cost <- function(input_df) {
  input_df <- input_df %>%
    mutate(
      #creating a column for low end of cost spectrum 
      #multiply the total number of acres by change in canopy cover fraction to estimate how much area needs to be restored of riparian area
      #multiply the total number of acres by the cost per acre
      lower_cost = rip_acres*can_ang_bin*case_when(
        intermediate_cost == "low" & bank_slope_class == "low" ~ 5000,
        intermediate_cost == "low" & bank_slope_class == "medium" ~ 20000,
        intermediate_cost == "low" & bank_slope_class == "high" ~ 60000,
        intermediate_cost == "medium" & bank_slope_class == "low" ~ 10000,
        intermediate_cost == "medium" & bank_slope_class == "medium" ~ 45000,
        intermediate_cost == "medium" & bank_slope_class == "high" ~ 70000,
        intermediate_cost == "high" & bank_slope_class == "low" ~ 30000,
        intermediate_cost == "high" & bank_slope_class == "medium" ~ 55000,
        intermediate_cost == "high" & bank_slope_class == "high" ~ 100000,
        # Add more conditions for other combinations here
        TRUE ~ 0  # Default value if no conditions match
      ),
      #creating a column for high end of cost spectrum 
      #multiply the total number of acres by the cost per acre
      upper_cost = rip_acres*can_ang_bin*case_when(
       intermediate_cost == "low" & bank_slope_class == "low" ~ 25000,
        intermediate_cost == "low" & bank_slope_class == "medium" ~ 50000,
        intermediate_cost == "low" & bank_slope_class == "high" ~ 100000,
        intermediate_cost == "medium" & bank_slope_class == "low" ~ 35000,
        intermediate_cost == "medium" & bank_slope_class == "medium" ~ 65000,
        intermediate_cost == "medium" & bank_slope_class == "high" ~ 120000,
        intermediate_cost == "high" & bank_slope_class == "low" ~ 50000,
        intermediate_cost == "high" & bank_slope_class == "medium" ~ 80000,
        intermediate_cost == "high" & bank_slope_class == "high" ~ 135000,
        # Add more conditions for other combinations here
        TRUE ~ 0  # Default value if no conditions match
      )
    )
  
  return(input_df)
}

rp_cost_final <- rp_cost(flow_stl_rp)
```


##SUBBASIN SUMMARY 
```{r}
#calculating final cost riparian planting by subbasin 
subba_rp_cost <- rp_cost_final %>%
  #dropping stream geometries
  st_drop_geometry() %>% 
  #grouping by subbasin
  group_by(noaa_subba) %>% 
  #adding up all lower cost ranges for reach costs by subbasin and multiplying by the producer price index 
  summarize(lower_subba_cost = sum(lower_cost)*ppi,
            upper_subba_cost = sum(upper_cost)*ppi,
            avg_subba_cost = (lower_subba_cost + upper_subba_cost)/2) %>% 
  #joining with subs_stl to get the geometries of the subbasins
  right_join(subs_stl[,1] ) %>% 
  #add subbasin salmon ppltn projected and current %>% 
  left_join(stilly_bens_rp %>% 
              select(subbasin, n, n_curr), by = c("noaa_subba" = "subbasin")) %>% 
  # finding increased increased fish from intervention
  mutate(n_diff = n - n_curr,
         #creatign a cost ebenfit ratio by dividing avg cost by # new fish
         cb_ratio = avg_subba_cost/n_diff) %>% 
  #reassigning it as sf b/c geometries became empty after le
  st_as_sf()

st_write(subba_rp_cost, here("data", "final_dfs", "rp_costs.gpkg"), delete_layer = TRUE)
```

### Mapping 

# MAP #1: Average Cost of RP Planting by Subbasin 
```{r}
#total cost
ggplot() +
  geom_sf(data = subba_rp_cost, aes(fill = avg_subba_cost)) +
  # scale_color_viridis_c() +
  scale_fill_viridis_b(breaks = c(10000000, 20000000, 30000000),
                       labels = c("$20", "$40", "$60"), option = "E") +
                       # direction=-1) +
  
  geom_sf(data = flow_stl, color = "blue", alpha = .3) +
  # scale_fill_continuous() +
  theme_minimal()+
  labs(title = "Average Cost of Riparian Planting by Subbasin") +
  labs(fill="$ Millions")
```

#Supporting Cost Figure 
```{r}
ggplot(subba_rp_cost, aes(x = noaa_subba)) +
  geom_errorbar(
    aes(ymin = lower_subba_cost/1000000, ymax = upper_subba_cost/1000000),
    position = "dodge",
    width = 0.2
  ) +
  geom_point(aes(y = avg_subba_cost/1000000), position = "dodge", size = 3) +
  labs(title = "FP Costs per Subbasin in the Stillaguamish",
       x = "Subbasin",
       y = "Cost (Millions of Dollars)") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


# MAP #2: Cost Benefit Ratio by Subbasin
```{r}
#total cost
ggplot() +
  geom_sf(data = subba_rp_cost, aes(fill = cb_ratio)) +
  # scale_color_viridis_c() +
  scale_fill_viridis_b(breaks = c(20000000, 40000000, 60000000),
                       labels = c("$20", "$40", "$60"), option = "E") +
                       # direction=-1) +
  
  geom_sf(data = flow_stl, color = "blue", alpha = .3) +
  # scale_fill_continuous() +
  theme_minimal()+
  labs(title = "Cost Benefit Ratio by Subbasin") +
  labs(fill="$ Millions")
```




#### NEXT STEPS: 
* CB ratio seems a bit wack. Shade only predicted to increase salmon by 0-15 per subbasin? refer to still_bens_rp
* Problem: all intermediate costs are low b/c transportation is all "low" and energy is all "low" or "medium"
* need to figure out how many acres along each stream need to be restored
  - cost estimates are given in $/acre. Literature says at least 30m inland
  - right now, I multiplied the area of the stream (length x bankfull width) by 2 and converted to acres. no idea if this is right
  
ASSUMPTIONS
* this assumes full restoration of all banks of every stream. what if we only want to restore partial riparian vegetation?
* assuming riparian vegetation is 2x the area of the stream

















